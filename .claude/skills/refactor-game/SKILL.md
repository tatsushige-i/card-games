---
name: refactor-game
description: 指定ゲームの規約準拠をチェックし、違反があればリファクタリングを行う。
argument-hint: "[ゲーム名(英語kebab-case)]"
---

# ゲームリファクタリングスキル

引数 `$ARGUMENTS` で指定されたゲームを、プロジェクト規約に準拠しているか検査し、違反があれば修正する。

## 前提条件

- 指定されたゲームが既に実装済みであること

## 表記ルール

以下の表記を使用する:

- `<game>` — 引数のゲーム名そのまま（kebab-case、例: `high-and-low`）
- `<Game>` — PascalCase に変換したゲーム名（例: `HighAndLow`）

## 実行プロセス

### Step 0: ブランチ準備

1. `main` ブランチで `git pull` を実行し、最新状態にする
2. `feature/refactor-$ARGUMENTS` ブランチを作成して切り替える

### Step 1: 規約の読み込み

以下のルールファイルを読み込み、**チェック基準を動的に構築する**:

1. `.claude/rules/architecture.md` — ファイル構成パターン・命名規則・共通パターンを把握する
2. `.claude/rules/conventions.md` — コーディング規約・デザイン要件を把握する
3. `.claude/rules/pitfalls.md` — 既知の注意点を把握する

これらのファイルが**唯一の正（Single Source of Truth）**である。以下の Step 2 のチェック観点はカテゴリの指針であり、具体的なチェック項目は上記ルールファイルの記載内容から導出すること。

### Step 2: 規約チェック

Step 1 で読み込んだルールに基づき、以下の観点で指定ゲームを検査し、違反を一覧化する。

#### 2.1 ファイル構成チェック

`architecture.md` の「ゲーム追加パターン」セクションに記載されたファイル構成に照らし、必須ファイル・テストファイルの存在を確認する。

#### 2.2 命名規則チェック

`architecture.md` の「共通パターン」「ゲーム追加パターン」から導出される命名規則に照らし、以下を確認する:

- 型名（`<Game>Phase`, `<Game>State` 等）
- export 名（`initial<Game>State`, `<game>Reducer` 等）
- Storage 関数名（`get<Game>BestScore` 等）・localStorage キー
- フック名（`use<Game>`）
- コンポーネント名・ファイル名のプレフィックス

具体的にどの名前が必要かは、`architecture.md` のパターン定義と、規約に準拠している既存ゲーム（`blackjack` 等）の実装を参考に判断する。

#### 2.3 パターン準拠チェック

`architecture.md` の「共通パターン」と `pitfalls.md` に記載されたパターンに照らし、以下を確認する:

- Board コンポーネントの `"use client"` ディレクティブ
- ページの Server Component（`"use client"` がないこと）
- `useSyncExternalStore` + キャッシュ済みスナップショットパターン
- その他、ルールファイルに記載された必須パターン

#### 2.4 ホーム画面登録チェック

`CLAUDE.md` の「ホーム画面へのゲーム登録」セクションに記載された登録要件を確認する。

#### 2.5 コメント言語チェック

`conventions.md` の規約に従い、コード内コメントが日本語で書かれているか確認する。

### Step 3: 違反の報告と修正

1. Step 2 で検出した違反を一覧でユーザーに報告する
2. 違反がない場合は「すべての規約に準拠しています」と報告して終了する
3. 違反がある場合は、以下の方針で修正する:
   - ファイル名のリネーム → `git mv` を使用する
   - 型名・export 名のリネーム → 定義元と全参照箇所を更新する
   - import パスの更新 → 関連ファイルすべてを更新する
   - 不足ファイルの作成 → 既存ゲーム（`blackjack` 等）のパターンを参考に作成する

### Step 4: 品質チェック

修正後に以下をすべてパスさせる:

```bash
npm run lint
npm run test:run
npm run build
```

エラーが発生した場合は修正し、すべてパスするまで繰り返す。

### Step 5: 完了報告

検出した違反と修正内容をまとめてユーザーに報告する。
